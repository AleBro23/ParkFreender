<!DOCTYPE html>
<html lang="it">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkFreender</title>
    <link rel="stylesheet" href="styles.css">
</head>

<script>
// All'inizio di ogni pagina HTML, controlla se l'utente è loggato
window.onload = function() {
    let info = JSON.parse(localStorage.getItem('authInfo'));
    if (info && info['access_token']) {
        // L'utente è loggato, quindi cambia il pulsante di login in logout
        document.querySelector('.buttonl').innerHTML = 'Log-out';
        document.querySelector('.buttonl').setAttribute('onclick', 'logout()');
    } else {
        // L'utente non è loggato, quindi mostra il pulsante di login
        document.querySelector('.buttonl').innerHTML = 'Sign In With Google';
        document.querySelector('.buttonl').setAttribute('onclick', 'signIn()');
    }
}

function logout(){
    let info = JSON.parse(localStorage.getItem('authInfo'));
    fetch("https://oauth2.googleapis.com/revoke?token=" + info['access_token'],{
        method:'POST',
        headers:{
            'Content-type':'application/x-www-form-urlencoded'
        }
    })
    .then((data) => {
        // Rimuovi le informazioni dell'utente dal localStorage
        localStorage.removeItem('authInfo');
        // Reindirizza l'utente alla pagina di login
        location.href = "http://localhost:8080/index_ParkFreender.html"
    })
}

</script>
<body>
    <header>
        <div class="logo">
            <img src="OIG2.png" alt="ParkFreender Logo">
        </div>
            <h1>ParkFreender</h1>
            <nav>
                <div class="nav-container">
                    <a href="index_ParkFreender.html" class="current">Home</a>
                    <a href="ParkFree.html">ParkFree</a>
                    <a href="#parkpay">ParkPay</a>
                    <a href="profile_ParkFreender.html">Il mio profilo</a>
                    <a href="#contact">Contatti</a>
                </div>
            </nav>
        <button class="buttonl" onclick="logout()">
            <span class="button-content">log-out</span>
        </button>
        
        </div>
    </header>
    <main>
        <h1>Welcome to Profile Page</h1>
        <h2 id="name">Your full name is:</h2>
        <h3 id="email">Your email is:</h3>
        <img id="image"/>
        
    </main>
</body>

<script>

    let params = {}
    
    let regex = /([^&=]+)=([^&]*)/g, m
    
    while(m = regex.exec(location.href)){
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2])
    }
    
    if(Object.keys(params).length > 0){
        localStorage.setItem('authInfo',JSON.stringify(params))
    }
    
    //hide access token
    
    window.history.pushState({},document.title, "/" + "profile_ParkFreender.html")
    
    let info = JSON.parse(localStorage.getItem('authInfo'))
    console.log(JSON.parse(localStorage.getItem('authInfo')))
    console.log(info['access_token'])
    console.log(info['expires_in'])
    
    //profile picture e email address
    fetch("https://www.googleapis.com/oauth2/v3/userinfo",{
        headers:{
            "Authorization":`Bearer ${info['access_token']}`
        }
    })
    .then((data) => data.json())
    .then((info) => {
        console.log(info)
        document.getElementById('name').innerHTML += info.name
        if(info.email) { // Verifica se la proprietà email esiste
            document.getElementById('email').innerHTML += info.email
        } else {
            document.getElementById('email').innerHTML += 'Non disponibile'
        }
        document.getElementById('image').setAttribute('src', info.picture) // Corretto qui
    })
    
    
    function logout(){
        fetch("https://oauth2.googleapis.com/revoke?token=" + info['access_token'],{
            method:'POST',
            headers:{
                'Content-type':'application/x-www-form-urlencoded'
            }
        })
        .then((data) => {
            location.href = "http://localhost:8080/index_ParkFreender.html"
        })
    }
    </script>

</html>
