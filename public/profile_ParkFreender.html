<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Reservations</title>
    <link rel="stylesheet" href="stylesProfile.css">
</head>

<script>
    // All'inizio di ogni pagina HTML, controlla se l'utente è loggato
    window.onload = function() {
        let info = JSON.parse(localStorage.getItem('authInfo'));
        if (info && info['access_token']) {
            // L'utente è loggato, quindi cambia il pulsante di login in logout
            document.querySelector('.buttonl').innerHTML = 'Log-out';
            document.querySelector('.buttonl').setAttribute('onclick', 'logout()');
        } else {
            // L'utente non è loggato, quindi mostra il pulsante di login
            document.querySelector('.buttonl').innerHTML = 'Sign In With Google';
            document.querySelector('.buttonl').setAttribute('onclick', 'signIn()');
        }
    }
    
    function logout(){
        let info = JSON.parse(localStorage.getItem('authInfo'));
        fetch("https://oauth2.googleapis.com/revoke?token=" + info['access_token'],{
            method:'POST',
            headers:{
                'Content-type':'application/x-www-form-urlencoded'
            }
        })
        .then((data) => {
            // Rimuovi le informazioni dell'utente dal localStorage
            localStorage.removeItem('authInfo');
            // Reindirizza l'utente alla pagina di login
            location.href = "http://localhost:8080/index_ParkFreender.html"
        })
    }
    
</script>

<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"></div>
            <nav>
                <ul>
                    <li><a href="../index_ParkFreender.html">Home</a></li>
                    <li><a href="../parkFree_ParkFreender.html">ParkFree</a></li>
                    <li><a href="#">ParkPay</a></li>
                    <li><a href="#" class="active">Profile</a></li>
                    <li><a href="#">Contact Us</a></li>
                </ul>
            </nav>
        </aside>
        <main class="content">
            <header class="header">
                <input type="text" placeholder="Search">
                <div class="user">
                    <img src="../Image/Home/Profile_image_examples/pr1.png" alt="User">
                </div>
            </header>
            <section class="profile">
                <div class="profile-header">
                    <img src="../Image/Home/Profile_image_examples/pr1.png" alt="Profile Picture" class="profile-pic">
                    <h2>Giangiorgia Bellimbusto</h2>
                    <span class="user-status">Authenticated user</span>
                    <button class="buttonl" onclick="logout()">Log-out</button>
                </div>
                <div class="profile-details">
                    <p>Email: <a href="mailto:runolfsdir.gillian@hotmail.com">runolfsdir.gillian@hotmail.com</a></p>
                    <p>Gender: Female</p>
                    <p>Alerts: Allows Marketing Notifications</p>
                </div>
                <div class="stats">
                    <button class="stat" onclick="updateContent('favourite-parks')">
                        <h3>5</h3>
                        <p>Favourite Parks</p>
                    </button>
                    <button class="stat" onclick="updateContent('my-feedbacks')">
                        <h3>2</h3>
                        <p>My Feedbacks</p>
                    </button>
                    <button class="stat" onclick="updateContent('my-transactions')">
                        <h3>2</h3>
                        <p>My Transactions</p>
                    </button>
                </div>
                <div class="reservations">
                    <h3>Favourite Parks</h3>
                    <ul id="reservations-list">
                        <li>
                            <span class="date">29 Sep</span>
                            <span class="park">San Severino</span>
                            <span class="reservation-status payment">Payment</span>
                            <span class="price">3€/h</span>
                        </li>
                        <li>
                            <span class="date">15 Oct</span>
                            <span class="park">San Bartolino</span>
                            <span class="reservation-status timedisk">Time disk</span>
                            <span class="price">2h</span>
                        </li>
                        <li>
                            <span class="date">11 Nov</span>
                            <span class="park">Ex Zuffo</span>
                            <span class="reservation-status free">Free</span>
                            <span class="price">free</span>
                        </li>
                        <li>
                            <span class="date">13 Apr</span>
                            <span class="park">Lidl Via Brennero</span>
                            <span class="reservation-status free">Free</span>
                            <span class="price">free</span>
                        </li>
                        <li>
                            <span class="date">24 Feb</span>
                            <span class="park">Cimitero Comunale</span>
                            <span class="reservation-status timedisk">Time disk</span>
                            <span class="price">2€/h</span>
                        </li>
                    </ul>
                </div>
            </section>
        </main>
    </div>
    <script src="scriptProfile.js"></script>
</body>

<script>

    let params = {}
    
    let regex = /([^&=]+)=([^&]*)/g, m
    
    while(m = regex.exec(location.href)){
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2])
    }
    
    if(Object.keys(params).length > 0){
        localStorage.setItem('authInfo',JSON.stringify(params))
    }
    
    //hide access token
    
    window.history.pushState({},document.title, "/" + "profile_ParkFreender.html")
    
    let info = JSON.parse(localStorage.getItem('authInfo'))
    console.log(JSON.parse(localStorage.getItem('authInfo')))
    console.log(info['access_token'])
    console.log(info['expires_in'])
    
    //profile picture e email address
    fetch("https://www.googleapis.com/oauth2/v3/userinfo",{
        headers:{
            "Authorization":`Bearer ${info['access_token']}`
        }
    })
    .then((data) => data.json())
    .then((info) => {
        console.log(info)
        document.getElementById('name').innerHTML += info.name
        if(info.email) { // Verifica se la proprietà email esiste
            document.getElementById('email').innerHTML += info.email
        } else {
            document.getElementById('email').innerHTML += 'Non disponibile'
        }
        document.getElementById('image').setAttribute('src', info.picture) // Corretto qui
    })
    
    
    function logout(){
        fetch("https://oauth2.googleapis.com/revoke?token=" + info['access_token'],{
            method:'POST',
            headers:{
                'Content-type':'application/x-www-form-urlencoded'
            }
        })
        .then((data) => {
            location.href = "http://localhost:3000/index_ParkFreender.html"
        })
    }
</script>
</html>
